
# Описание работы ETL

## Конфигурация системы

Конфигурационные данные хранятся в файле config.yaml. 


API_CONNECTION - информация для подключение к веб-серверу:

- URL - адрес подключения к API.
- Token - токен зарегистрированного пользователя.
- Currency  - список валют, информация о которых будет загружаться
- Base - базовая валюта, от которой будет отсчитыватся стоимость. `WARNING` - смена Base валюты недоступна в бесплатном тарифе. По умолчанию стоит Евро.


DATABASE - информация для подключения к базе данных MySQL
- Host - IP-адрес, где размешается БД
- UserName - имя пользователя
- Password - пароль
- Port - порт подключения
- Databases: - список баз данных, к которым будет осуществляться подключение

## Загрузка данных с веб-сервера

Загрузка информации о курсе валют осуществляется с помощью файла DataLoader.py

Скрипт имеет набор аргументов, управляющих работой алгоритма:

 `-o` `--option` - режим загрузки данных. Может принимать следующие значения:
 - latest - загрузить информацию о курсе валют на текущий день. `Значение по умолчанию`
 - hist - загрузить историческую информацию о курсе валют на конкретную дату.
 - timeseries - загрузить информацию о курсе валют на заданный промежуток времени. `WARNING` - недоступно для использования при бесплатном тарифе. 
 - example - загрузить демонстратионный набор данных. Загружает информацию о курсе валют за последние полгода. `WARNING` - обходит ограничение timeseries, путем перебора дат в цикле и отправке запросов типа hist. Таким образом получается 180 запросов к API. Учитывая ограниченность бесплатной версии  

Используется только с режимом `hist`:

`-d` `--date` - историческая дата на которую хотим загрузить информацию о курсе валют. Формат ввода: `YYYY-MM-DD`

Используется только с режимом `timeseries`:

`-s` `--start_date` - начальная дата временной рамки `timeseries`.  Формат ввода: `YYYY-MM-DD`

`-e` `--end_date` - конечная дата временной рамки `timeseries`.  Формат ввода: `YYYY-MM-DD`

Загруженные с веб-сервера данные помещаются в файл `/temp/temp.csv`.

Исключение: `example` помещает данные в `/temp/example.csv`.

## Загрузка в базу данных

Загрузка информации в базу данных MySQL осуществляется с помощью DBModel.py.

Скрипт имеет следующий аргумент:

`-i` `--insert` - режим вставки данных. Может принимать два значения:

`-rate` - вставка данных в таблицу rate (извлечение данных из `/temp/temp.csv`).

`-example` - начальное заполнение данных из файла `example.csv`. Применять только для пустой БД.

## Витрина данных

Витрина данных состоит из View таблиц `rates_view`, `locale`, `composite_rate`. С их помощью можно найти информацию о курсах валют как на конкретный день, так и в диапазоне дат. 

В качестве примеров использования витрины данных, были созданы представления `exchange_rub`, `exchange_cost_rub`, 'currency_on_date'

## Автоматизация запуска скриптов

Для автоматизация запуска скриптов используется `python-crontab`
Ежедневно, в 7 часов утра выполняются следующие действия:
1. Запуск скрипта для загрузки с API: DataLoader.py `-o` latest;
2. Запуск скрипта для вставки данных в БД: DBModel.py `-i` rate;
3. Удаление файла `/temp/temp.csv`.
